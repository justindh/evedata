{{define "body"}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.10.0/js-yaml.min.js"></script>
<h3 id="serviceName">serviceName</h3>
<h4 id="integrationType">Integration Type</h4>

{{template "checkAuthentication" .}}
	<div class="modal fade" id="addchannel">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button aria-label="Close" class="close" data-dismiss=
					"modal" type="button"><span aria-hidden=
					"true">&times;</span></button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<p>Select a channel to add to the integration.</p>
					<div class="form-group">
						<label>Add Channel</label> <select class="form-control" name="channels" id="channels"></select>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-default" data-dismiss="modal" type=
					"button">Close</button> <button class=
					"btn btn-primary submit" id="submitchannel" type="button">Submit</button>
				</div>
			</div>
		</div>
	</div>

	<div class="table-responsive">
		<div class="toolbar channelsToolbar" id="channelsToolbar">
			<h4>Integrated Channels</h4>
			<a class="addchannel btn btn-default" href="javascript:">Add Channel</a>
		</div>

		<table class="table" data-cache="false" data-toolbar=".channelsToolbar" id="channelsTable">
			<thead>
				<tr>
					<th data-field="channelName">Channel Name</th>
					<th data-field="channelID">ChannelID</th>
					<th data-field="services">Services</th>
					<th data-field="options" data-formatter="yamlFormatter">Options</th>
					<th data-align="center" data-events="actionEvents"
					data-field="action" data-formatter="ChannelsActionsFormatter">Delete</th>
				</tr>
			</thead>
		</table>
	</div>

	<div class="table-responsive">
		<div class="toolbar sharesToolbar" id="sharesToolbar">
			<h4>Characters Sharing Data</h4>
		</div>
		<table class="table" data-cache="false" data-toolbar=".sharesToolbar" id="sharesTable">
			<thead>
				<tr>
					<th data-field="tokenCharacterName" data-formatter="tokenCharacterFormatter">Character</th>
					<th data-field="entityName" data-formatter="entityTypeFormatter">Entity</th>
					<th data-field="types">Types</th>
					<th data-field="ignored" data-align="center" data-events="actionEvents" data-formatter="ShareActionsFormatter">Ignore</th>
				</tr>
			</thead>
		</table>
	</div>

	<script>		
		var	$addchannel = $('#addchannel').modal({show: false}),
			$channelsTable = $('#channelsTable').bootstrapTable({},"changeLocale", "en_US"),
			$sharesTable = $('#sharesTable').bootstrapTable({},"changeLocale", "en_US");
	
		$('.addchannel').click(function () {
			$addchannel.find('.modal-title').text("Add Channel to Integration");
			$addchannel.modal('show');
		});

		$(function () {
			updateService();
		});
		function ChannelsActionsFormatter(value, row) {
			return [
				'<a class="removeChannel" href="javascript:" title="Delete Item"><i class="glyphicon glyphicon-remove-circle"><\/i><\/a>',
			].join('');
		}

		function ShareActionsFormatter(value, row) {
			console.log(value);
			if (value == 1) {
				value = "&#10003;";
			} else {
				value = "&#10008";
			}
			return '<a class="toggleignore" style="text-decoration: none;" href="javascript:void(0)" title="Toggle Ignore">'+value+'<\/a>' ;
		}

		function yamlFormatter(value, row) {
			return '<pre>' + jsyaml.safeDump(value) + '</pre>';
		}

		// update and delete events
		window.actionEvents = {
			'click .removeChannel': function (e, value, row) {
				if (confirm('Are you sure you want to delete this channel?')) {
					console.log(row);
					$.ajax({
						url: "/U/botServiceChannels?botServiceID=" + row.botServiceID + "&channelID=" + row.channelID,
						type: 'delete',
						success: function () {
							showAlert('Delete channel successful!', 'success');
							updateService();
						},
						error: function () {
							showAlert('Delete channel error!', 'danger');
						}
					})
				}
			},
			'click .toggleignore': function (e, value, row) {
				$.ajax({
					url: "/U/botShareToggleIgnore?tokenCharacterID=" + row.tokenCharacterID + "&botServiceID="+ row.botServiceID,
					type: 'post',
					success: function () {
						updateService();
						showAlert('Ignore state changed for ' + row.tokenCharacterName +'!', 'success');
					},
					error: function () {
						showAlert('Error changing authentication state!', 'danger');
					}
				})
			}
		};
		$addchannel.find('#submitchannel').click(function () {
			$.ajax({
				type: "POST",
				url: "/U/botServiceChannels",
				data: {
					channelID: $('#channels').children(":selected").attr("id"),
					botServiceID: getUrlVars()["botServiceID"],
				}
			})
			.done(function() {
				updateService();
				$addchannel.modal('hide');
				})
			.fail(function(error) {
				$addchannel.modal('hide');
				showAlert( 'Add Discord Failed: ' + error.responseText, 'danger');
			});
		});

	function updateService() {
		$.ajax({
				url: '/U/botDetails?botServiceID=' + getUrlVars()["botServiceID"],
				dataType:'JSON',
				success:updateServiceData,
				error:function(err){
					alert("Could not find information on this service: " + err.responseText)
				}
			});
	}

	function updateServiceData(d) {
		$("#serviceName").html(d.name);
		$("#integrationType").html(d.type).css('textTransform', 'capitalize');
		if (d.Channels) {
			$channelsTable.bootstrapTable('load', d.Channels);
		} else {
			$channelsTable.bootstrapTable('removeAll');
		}
		if (d.Shares) {
			$sharesTable.bootstrapTable('load', d.Shares);
		}else {
			$sharesTable.bootstrapTable('removeAll');
		}

		$.ajax({
			url: '/U/botServiceChannels?botServiceID=' + getUrlVars()["botServiceID"],
			dataType:'JSON',
			success:function(data){
				$.each(data, function(key, val){
					var found = false;
					$.each(d.Channels, function(key, channel) {
						if (channel.channelID == val.channelID) {
							found = true;
						}
					})
					if (!found) {
						$('#channels').append('<option id=' + val.channelID + '>' + val.channelName + '</option>');
					}
				})
			},
			error:function(){
				alert("Error receiving channels.")
			}
		});

	}
	</script>
{{end}}