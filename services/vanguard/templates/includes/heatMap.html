{{define "heatmap"}}
<div id="{{.ChartName}}"></div>
<script>
    var margin = {
            top: 15,
            right: 0,
            bottom: 100,
            left: 20
        },
        gridSize = 16,
        width = gridSize * 24,
        height = gridSize * 7,

        legendElementWidth = gridSize * 2,
        buckets = 9,
        colors = ["#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4",
            "#1d91c0", "#225ea8", "#253494", "#081d58"
        ],
        days = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"],
        times = ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09",
            "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
            "21", "22", "23"
        ];

    $.ajax({
        type: "GET",
        contentType: "application/json; charset=utf-8",
        url: '{{.DataURL}}',
        dataType: 'json',
        async: true,
        data: "{}",
        success: function (data) {
            var colorScale = d3.scaleQuantile()
                .domain([0, buckets - 1, d3.max(data, function (d) {
                    return d.value;
                })])
                .range(colors);


            var svg = d3.select("{{.ChartName}}").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," +
                    margin.top +
                    ")");

            var dayLabels = svg.selectAll(".dayLabel")
                .data(days)
                .enter().append("text")
                .text(function (d) {
                    return d;
                })
                .attr("x", 0)
                .attr("y", function (d, i) {
                    return i * gridSize;
                })
                .style("text-anchor", "end")
                .attr("transform", "translate(-6," + gridSize / 1.5 +
                    ")")
                .attr("class", function (d, i) {
                    return ((i >= 0 && i <= 4) ?
                        "dayLabel mono axis axis-workweek" :
                        "dayLabel mono axis");
                });

            var timeLabels = svg.selectAll(".timeLabel")
                .data(times)
                .enter().append("text")
                .text(function (d) {
                    return d;
                })
                .attr("x", function (d, i) {
                    return i * gridSize;
                })
                .attr("y", 0)
                .style("text-anchor", "middle")
                .attr("transform", "translate(" + gridSize / 2 +
                    ", -6)")
                .attr("class", function (d, i) {
                    return ((i >= 7 && i <= 16) ?
                        "timeLabel mono axis axis-worktime" :
                        "timeLabel mono axis");
                });

            var heatMap = svg.selectAll(".hour")
                .data(data)
                .enter().append("rect")
                .attr("x", function (d) {
                    return (d.hour - 1) * gridSize;
                })
                .attr("y", function (d) {
                    return (d.day - 1) * gridSize;
                })
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("class", "hour bordered")
                .attr("width", gridSize)
                .attr("height", gridSize)
                .style("fill", colors[0]);

            heatMap.style("fill", function (d) {
                return colorScale(d.value);
            });
            heatMap.append("title").text(function (d) {
                return d.value;
            });
        },
        error: function (result) {
            showAlert("Could not load {{.ChartName}}")
        }
    })
</script>
{{end}}