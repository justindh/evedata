{{define "body"}}
<h3>Characters</h3>
{{template "checkAuthentication" .}}
<p>Adding characters to your account opens up more features of our website.<br>If you are not comfortable sharing some information, such as wallet journals, etc. You can disable groups of scopes by unchecking the option before adding the character.<br>Should you ever wish to change scopes, add the same character a second time and it will overwrite the available scopes.</p>
	<script>
		var options = [];
		$('body').on('click', function(event) {
			var $target = $(event.target);
			if ($target.hasClass('characterScopes')) {
				
				var val = $target.attr( 'data-value' ),
					$inp = $target.find( 'input' ),
					idx;

				if ((idx = options.indexOf(val)) > -1 ) {
					options.splice(idx, 1);
					setTimeout(function() { $inp.prop( 'checked', true ) }, 0);
				} else {
					options.push( val );
					setTimeout(function() { $inp.prop('checked', false) }, 0);
				}

				$( event.target ).blur();
				return false;
			}
		});	
	</script>

	<div class="table-responsive">
		<div class="toolbar cresttokenToolbar" id="cresttokenToolbar">
			<div class="dropdown">
				<button type="button" class="btn btn-default btn-sm dropdown-toggle" id="addChar" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					Add Character
					<span class="caret"></span>
				</button>
				<ul class="dropdown-menu" id="addCharMenu" aria-labelledby="addChar">
					{{ range $scope, $reason := .ScopeGroups }}
						<li><a href="#" id="{{ $scope }}" class="small characterScopes" data-value="{{ $scope }}" tabIndex="-1"><input type="checkbox" CHECKED>&nbsp;{{ $reason }}</a></li>
					{{ end }}   
					<br> 
					<li>
						<a class="addcrest btn btn-default" href="javascript:">Add Character</a>
					</li> 
				</ul>
			</div>
		</div>

		<table class="table" data-show-refresh="true" data-cache="false" data-toolbar=".cresttokenToolbar"
			data-url="/U/CRESTTokens" id="cresttable">
			<thead>
				<tr>
					<th data-field="characterName" data-formatter="accountNameFormatter">Name</th>
					<th data-field="scopes">Scope Groups</th>
					<th data-field="lastStatus">Last Status</th>
					<th data-align="center" data-events="actionEvents"
					data-field="action" data-formatter="CRESTTokenFormatter">
					Delete</th>
				</tr>
			</thead>
		</table>
	<p style="font-size: 12px">Note: You will need to press CANCEL on the EVE Logon to relog on and add characters from alternate accounts.</p>
	<br><br><br><br><br><br><br><br><br><br>
	</div>

	<script>
		var 	$cresttable = $('#cresttable').bootstrapTable({url: "/U/crestTokens"}, "changeLocale", "en_US");
				
		$(function () {
			// crest token click event
			$('.addcrest').click(function () {
				var scopeGroups = [];
				$('.characterScopes input:checkbox:checked').each(function(idx, val){
					scopeGroups.push(val.parentElement.id);
				});

				if (scopeGroups.length) {
					window.location.replace("/X/eveTokenAuth?scopeGroups=" + scopeGroups.join(","));
				} else {
					window.location.replace("/X/eveTokenAuth");
				}
			});
		});
		
		function queryParams(params) {
			return {};
		}

		function accountNameFormatter(value, row) {
			var scopes = row.scopes.replace(/\s+/g,  "\n");
			return '<i class="glyphicon glyphicon-th-list" data-toggle="tooltip" title="'+ scopes +'"><\/i> &nbsp; ' + value;
		}

		function CRESTTokenFormatter(value, row) {
			
			return [
				'<a class="removecrest" href="javascript:" title="Delete Item"><i class="glyphicon glyphicon-remove-circle"><\/i><\/a>',
			].join('');
		}
		// update and delete events
		window.actionEvents = {
			'click .removecrest': function (e, value, row) {
				if (confirm('Are you sure you want to delete this token?')) {
					$.ajax({
						url: "/U/crestTokens?tokenCharacterID=" + row.tokenCharacterID,
						type: 'delete',
						success: function () {
							$cresttable.bootstrapTable('refresh');
							showAlert('Delete item successful!', 'success');
						},
						error: function () {
							showAlert('Delete item error!', 'danger');
						}
					})
				}
			}
		};
	</script>
{{end}}