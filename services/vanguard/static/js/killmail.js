var package = 
{
    "attributes": {
       "ship": {
          "agility": 1.6758721667635548,
          "armorAvgDamageResonance": 0.675,
          "armorEmDamageResonance": 0.5,
          "armorExplosiveDamageResonance": 0.9,
          "armorHP": 700.625,
          "armorKineticDamageResonance": 0.75,
          "armorMaxDamageResonance": 0.9,
          "armorMinDamageResonance": 0.5,
          "armorThermalDamageResonance": 0.55,
          "armorUniformity": 0.75,
          "avgDamageResonance": 0.67,
          "avgEHP": 3915.131240349974,
          "avgRPS": 15.640941434044882,
          "baseWarpSpeed": 1,
          "capacitorCapacity": 400,
          "capacitorDurationMWD": 119000,
          "capacitorFraction": 0.5152164554750887,
          "capacitorStable": 1,
          "capacity": 130,
          "cpuLoad": 232,
          "cpuOutput": 238.2975,
          "cpuRemaining": 6.297500000000014,
          "emDamageResonance": 0.67,
          "explosiveDamageResonance": 0.67,
          "fwLpKill": 38,
          "gfxBoosterID": 397,
          "heatAttenuationHi": 0.5,
          "heatAttenuationLow": 0.5,
          "heatAttenuationMed": 0.63,
          "heatCapacityHi": 100,
          "heatCapacityLow": 100,
          "heatCapacityMed": 100,
          "heatDissipationRateHi": 0.01,
          "heatDissipationRateLow": 0.01,
          "heatDissipationRateMed": 0.01,
          "heatGenerationMultiplier": 1,
          "hiSlots": 3,
          "hp": 560,
          "kineticDamageResonance": 0.67,
          "lowSlots": 3,
          "mainColor": 16777215,
          "mass": 1487000,
          "maxDamageResonance": 0.67,
          "maxDirectionalVelocity": 3000,
          "maxEHP": 5300.820895522388,
          "maxLockedTargets": 5,
          "maxPassengers": 2,
          "maxRPS": 22.67936507936508,
          "maxTargetRange": 43750,
          "maxVelocity": 595.184052000159,
          "maxVelocityMWD": 4267.400226857778,
          "medSlots": 4,
          "metaGroupID": 4,
          "metaLevel": 8,
          "minDamageResonance": 0.67,
          "minEHP": 3068.320895522388,
          "minRPS": 11.33968253968254,
          "minTargetVelDmgMultiplier": 0.05,
          "moduleAlphaDamage": 881.71875,
          "moduleDPS": 111.78746987621864,
          "powerLoad": 56.39999999999999,
          "powerOutput": 60,
          "powerRemaining": 3.6000000000000085,
          "powerToSpeed": 1,
          "propulsionGraphicID": 397,
          "radius": 50,
          "rechargeRate": 146250,
          "requiredSkill1": 3330,
          "requiredSkill1Level": 3,
          "requiredSkill2": 3328,
          "requiredSkill2Level": 3,
          "rigSize": 1,
          "rigSlots": 3,
          "scanGravimetricStrength": 15.6,
          "scanResolution": 812.5,
          "scanSpeed": 1125,
          "shieldAvgDamageResonance": 0.7250000000000001,
          "shieldCapacity": 2232.5,
          "shieldEmDamageResonance": 1,
          "shieldExplosiveDamageResonance": 0.5,
          "shieldKineticDamageResonance": 0.6,
          "shieldMaxDamageResonance": 1,
          "shieldMinDamageResonance": 0.5,
          "shieldRechargeRate": 492187.5,
          "shieldThermalDamageResonance": 0.8,
          "shieldUniformity": 1,
          "shipBonusCF2": 125,
          "shipBonusGF2": 50,
          "shipBonusRole7": 200,
          "shipBonusRole8": -50,
          "signatureRadius": 37,
          "signatureRadiusMWD": 203.5,
          "structureUniformity": 1,
          "techLevel": 1,
          "thermalDamageResonance": 0.67,
          "totalAlphaDamage": 881.71875,
          "totalDPS": 111.78746987621864,
          "totalWarpScrambleStrength": 3,
          "typeColorScheme": 11318,
          "uniformity": 1,
          "upgradeCapacity": 350,
          "upgradeSlotsLeft": 3,
          "volume": 27289,
          "warpCapacitorNeed": 0.00000134,
          "warpSpeedMultiplier": 5
       },
       "modules": {
          "0": {
             "cpuOutputBonus2": 7.1,
             "hp": 40,
             "location": 94,
             "mass": 200,
             "radius": 100,
             "rigSize": 1,
             "shieldRechargeRateMultiplier": 1.05,
             "techLevel": 1,
             "typeID": 26929,
             "upgradeCost": 150,
             "volume": 5
          },
          "1": {
             "agilityMultiplier": -15.75,
             "hp": 40,
             "implantBonusVelocity": 9.5,
             "location": 12,
             "mass": 100,
             "metaLevel": 5,
             "radius": 50,
             "requiredSkill1": 3394,
             "requiredSkill1Level": 2,
             "structureHPMultiplier": 0.8,
             "techLevel": 2,
             "typeID": 2605,
             "volume": 5
          },
          "10": {
             "drawback": -5,
             "hp": 40,
             "implantBonusVelocity": 5.5,
             "location": 92,
             "mass": 200,
             "radius": 100,
             "rigSize": 1,
             "techLevel": 1,
             "typeID": 31177,
             "upgradeCost": 100,
             "volume": 5
          },
          "11": {
             "agility": 0.00014449800378458,
             "aimedLaunch": 1,
             "alphaDamage": 293.90625,
             "aoeCloudSize": 30,
             "aoeDamageReductionFactor": 0.604,
             "aoeFalloff": 1500,
             "aoeVelocity": 255,
             "capacity": 0.795,
             "chargeGroup1": 384,
             "chargeGroup2": 394,
             "chargeGroup4": 653,
             "chargeRate": 1,
             "chargeTypeID": 27381,
             "cpu": 18,
             "damageMultiplier": 1,
             "detonationRange": 35,
             "dps": 37.26248995873954,
             "duration": 7887.456000000001,
             "emDamageResonance": 1,
             "explosionDelay": 3750,
             "explosiveDamage": 293.90625,
             "explosiveDamageResonance": 0.8,
             "heatAbsorbtionRateModifier": 0.02,
             "heatDamage": 2.4,
             "hp": 60,
             "kineticDamageResonance": 1,
             "launcherGroup": 509,
             "location": 29,
             "mass": 700,
             "maxVelocity": 16875,
             "metaGroupID": 4,
             "metaLevel": 2,
             "overloadRofBonus": -15,
             "power": 6.3,
             "radius": 300,
             "reloadTime": 10000,
             "requiredSkill1": 3321,
             "requiredSkill1Level": 1,
             "requiredSkill2": 3319,
             "requiredSkill2Level": 1,
             "requiredThermoDynamicsSkill": 1,
             "slots": 1,
             "speed": 7887.456000000001,
             "structureUniformity": 1,
             "techLevel": 1,
             "thermalDamageResonance": 1,
             "typeColorScheme": 11325,
             "typeID": 2404,
             "volume": 0.015
          },
          "12": {
             "agility": 0.00014449800378458,
             "aimedLaunch": 1,
             "alphaDamage": 293.90625,
             "aoeCloudSize": 30,
             "aoeDamageReductionFactor": 0.604,
             "aoeFalloff": 1500,
             "aoeVelocity": 255,
             "capacity": 0.795,
             "chargeGroup1": 384,
             "chargeGroup2": 394,
             "chargeGroup4": 653,
             "chargeRate": 1,
             "chargeTypeID": 27381,
             "cpu": 18,
             "damageMultiplier": 1,
             "detonationRange": 35,
             "dps": 37.26248995873954,
             "duration": 7887.456000000001,
             "emDamageResonance": 1,
             "explosionDelay": 3750,
             "explosiveDamage": 293.90625,
             "explosiveDamageResonance": 0.8,
             "heatAbsorbtionRateModifier": 0.02,
             "heatDamage": 2.4,
             "hp": 60,
             "kineticDamageResonance": 1,
             "launcherGroup": 509,
             "location": 28,
             "mass": 700,
             "maxVelocity": 16875,
             "metaGroupID": 4,
             "metaLevel": 2,
             "overloadRofBonus": -15,
             "power": 6.3,
             "radius": 300,
             "reloadTime": 10000,
             "requiredSkill1": 3321,
             "requiredSkill1Level": 1,
             "requiredSkill2": 3319,
             "requiredSkill2Level": 1,
             "requiredThermoDynamicsSkill": 1,
             "slots": 1,
             "speed": 7887.456000000001,
             "structureUniformity": 1,
             "techLevel": 1,
             "thermalDamageResonance": 1,
             "typeColorScheme": 11325,
             "typeID": 2404,
             "volume": 0.015
          },
          "2": {
             "capacityBonus": 1200,
             "cpu": 28,
             "hp": 40,
             "location": 21,
             "metaGroupID": 4,
             "metaLevel": 8,
             "power": 19.5,
             "requiredSkill1": 3425,
             "requiredSkill1Level": 1,
             "signatureRadiusAdd": 5,
             "techLevel": 1,
             "typeID": 31928,
             "volume": 10
          },
          "3": {
             "cpu": 40,
             "hp": 40,
             "location": 13,
             "mass": 1,
             "metaLevel": 5,
             "missileDamageMultiplierBonus": 1.1,
             "power": 1,
             "radius": 1,
             "requiredSkill1": 3318,
             "requiredSkill1Level": 4,
             "speedMultiplier": 0.895,
             "techLevel": 2,
             "typeID": 22291,
             "volume": 5
          },
          "4": {
             "capacitorNeed": 22.5,
             "cpu": 44,
             "duration": 5000,
             "heatAbsorbtionRateModifier": 0.02,
             "heatDamage": 3.75,
             "hp": 40,
             "location": 20,
             "maxRange": 36000,
             "metaLevel": 5,
             "overloadRangeBonus": 20,
             "power": 1,
             "requiredSkill1": 3435,
             "requiredSkill1Level": 2,
             "requiredThermoDynamicsSkill": 1,
             "techLevel": 2,
             "typeID": 3244,
             "volume": 5,
             "warpScrambleStrength": 1
          },
          "5": {
             "activationBlockedStrenght": 1,
             "capacitorNeed": 3.75,
             "cpu": 26,
             "duration": 5000,
             "heatAbsorbtionRateModifier": 0.01,
             "heatDamage": 3.75,
             "hp": 40,
             "location": 19,
             "maxRange": 11250,
             "maxVelocityMultiplier": 1,
             "metaLevel": 1,
             "overloadRangeBonus": 20,
             "power": 1,
             "radius": 1,
             "requiredSkill1": 3435,
             "requiredSkill1Level": 1,
             "requiredSkill2": 3449,
             "requiredSkill2Level": 1,
             "requiredThermoDynamicsSkill": 1,
             "techLevel": 1,
             "typeID": 5445,
             "volume": 5,
             "warpScrambleStrength": 2
          },
          "6": {
             "cpu": 15,
             "hp": 40,
             "location": 11,
             "powerIncrease": 10,
             "requiredSkill1": 3418,
             "requiredSkill1Level": 2,
             "techLevel": 1,
             "typeID": 11563,
             "volume": 20
          },
          "7": {
             "capacitorCapacityMultiplier": 0.8,
             "capacitorNeed": 33.75,
             "cpu": 25,
             "deadspaceUnsafe": 1,
             "duration": 10000,
             "heatAbsorbtionRateModifier": 0.04,
             "heatDamage": 14.25,
             "hp": 40,
             "location": 22,
             "massAddition": 500000,
             "maxGroupActive": 1,
             "metaLevel": 1,
             "overloadSpeedFactorBonus": 50,
             "power": 15,
             "radius": 1,
             "requiredSkill1": 3454,
             "requiredSkill1Level": 1,
             "requiredThermoDynamicsSkill": 1,
             "signatureRadiusBonus": 450,
             "speedBoostFactor": 1500000,
             "speedFactor": 636.768661735037,
             "techLevel": 1,
             "typeID": 35658,
             "volume": 10
          },
          "8": {
             "agility": 0.00014449800378458,
             "aimedLaunch": 1,
             "alphaDamage": 293.90625,
             "aoeCloudSize": 30,
             "aoeDamageReductionFactor": 0.604,
             "aoeFalloff": 1500,
             "aoeVelocity": 255,
             "capacity": 0.795,
             "chargeGroup1": 384,
             "chargeGroup2": 394,
             "chargeGroup4": 653,
             "chargeRate": 1,
             "chargeTypeID": 27381,
             "cpu": 18,
             "damageMultiplier": 1,
             "detonationRange": 35,
             "dps": 37.26248995873954,
             "duration": 7887.456000000001,
             "emDamageResonance": 1,
             "explosionDelay": 3750,
             "explosiveDamage": 293.90625,
             "explosiveDamageResonance": 0.8,
             "heatAbsorbtionRateModifier": 0.02,
             "heatDamage": 2.4,
             "hp": 60,
             "kineticDamageResonance": 1,
             "launcherGroup": 509,
             "location": 27,
             "mass": 700,
             "maxVelocity": 16875,
             "metaGroupID": 4,
             "metaLevel": 2,
             "overloadRofBonus": -15,
             "power": 6.3,
             "radius": 300,
             "reloadTime": 10000,
             "requiredSkill1": 3321,
             "requiredSkill1Level": 1,
             "requiredSkill2": 3319,
             "requiredSkill2Level": 1,
             "requiredThermoDynamicsSkill": 1,
             "slots": 1,
             "speed": 7887.456000000001,
             "structureUniformity": 1,
             "techLevel": 1,
             "thermalDamageResonance": 1,
             "typeColorScheme": 11325,
             "typeID": 2404,
             "volume": 0.015
          },
          "9": {
             "drawback": -5,
             "hp": 40,
             "location": 93,
             "mass": 200,
             "maxTargetRangeBonus": 25,
             "radius": 100,
             "rigSize": 1,
             "techLevel": 1,
             "typeID": 31274,
             "upgradeCost": 50,
             "volume": 5
          }
       },
       "types": {
          "11563": "Micro Auxiliary Power Core I",
          "22291": "Ballistic Control System II",
          "2404": "Light Missile Launcher II",
          "2605": "Nanofiber Internal Structure II",
          "26929": "Small Processor Overclocking Unit I",
          "27381": "Caldari Navy Nova Light Missile",
          "31177": "Small Polycarbon Engine Housing I",
          "31274": "Small Ionic Field Projector I",
          "31928": "Republic Fleet Medium Shield Extender",
          "3244": "Warp Disruptor II",
          "33816": "Garmur",
          "35658": "5MN Quad LiF Restrained Microwarpdrive",
          "5445": "Initiated Compact Warp Scrambler"
       },
       "typeID": 33816
    },
    "killmail": {
       "attackers": [
          {
             "alliance_id": 99007892,
             "character_id": 139089093,
             "corporation_id": 583867044,
             "damage_done": 3395,
             "final_blow": true,
             "security_status": 5,
             "ship_type_id": 29984,
             "weapon_type_id": 3082
          },
          {
             "alliance_id": 1042504553,
             "character_id": 90442902,
             "corporation_id": 98295759,
             "security_status": 5,
             "ship_type_id": 3756,
             "weapon_type_id": 17559
          }
       ],
       "killmail_id": 72107118,
       "killmail_time": "2018-08-26T15:26:49-07:00",
       "solar_system_id": 30002902,
       "victim": {
          "alliance_id": 1042504553,
          "character_id": 2113164843,
          "corporation_id": 98295759,
          "damage_taken": 3395,
          "items": [
             {
                "flag": 12,
                "item_type_id": 2605,
                "quantity_destroyed": 1
             },
             {
                "flag": 27,
                "item_type_id": 27381,
                "quantity_dropped": 27
             },
             {
                "flag": 5,
                "item_type_id": 24495,
                "quantity_destroyed": 159
             },
             {
                "flag": 27,
                "item_type_id": 2404,
                "quantity_destroyed": 1
             },
             {
                "flag": 93,
                "item_type_id": 31274,
                "quantity_destroyed": 1
             },
             {
                "flag": 5,
                "item_type_id": 27381,
                "quantity_destroyed": 2993
             },
             {
                "flag": 92,
                "item_type_id": 31177,
                "quantity_destroyed": 1
             },
             {
                "flag": 5,
                "item_type_id": 24497,
                "quantity_destroyed": 2688
             },
             {
                "flag": 21,
                "item_type_id": 31928,
                "quantity_dropped": 1
             },
             {
                "flag": 13,
                "item_type_id": 22291,
                "quantity_destroyed": 1
             },
             {
                "flag": 29,
                "item_type_id": 27381,
                "quantity_destroyed": 27
             },
             {
                "flag": 20,
                "item_type_id": 3244,
                "quantity_dropped": 1
             },
             {
                "flag": 5,
                "item_type_id": 10151,
                "quantity_dropped": 1
             },
             {
                "flag": 19,
                "item_type_id": 5445,
                "quantity_dropped": 1
             },
             {
                "flag": 28,
                "item_type_id": 27381,
                "quantity_dropped": 27
             },
             {
                "flag": 11,
                "item_type_id": 11563,
                "quantity_destroyed": 1
             },
             {
                "flag": 29,
                "item_type_id": 2404,
                "quantity_dropped": 1
             },
             {
                "flag": 22,
                "item_type_id": 35658,
                "quantity_destroyed": 1
             },
             {
                "flag": 5,
                "item_type_id": 28668,
                "quantity_destroyed": 93
             },
             {
                "flag": 94,
                "item_type_id": 26929,
                "quantity_destroyed": 1
             },
             {
                "flag": 28,
                "item_type_id": 2404,
                "quantity_dropped": 1
             }
          ],
          "position": {
             "x": 2.9660983508154585e+12,
             "y": 3.174136878358056e+12,
             "z": 1.6309873863325543e+11
          },
          "ship_type_id": 33816
       }
    },
    "nameMap": {
       "10151": "Improved Crash Booster",
       "1042504553": "Solyaris Chtonium",
       "11563": "Micro Auxiliary Power Core I",
       "139089093": "highclam",
       "17559": "Federation Navy Stasis Webifier",
       "2113164843": "Norg Nalkan",
       "22291": "Ballistic Control System II",
       "2404": "Light Missile Launcher II",
       "24495": "Scourge Fury Light Missile",
       "24497": "Nova Fury Light Missile",
       "2605": "Nanofiber Internal Structure II",
       "26929": "Small Processor Overclocking Unit I",
       "27381": "Caldari Navy Nova Light Missile",
       "28668": "Nanite Repair Paste",
       "29984": "Tengu",
       "3082": "250mm Railgun II",
       "31177": "Small Polycarbon Engine Housing I",
       "31274": "Small Ionic Field Projector I",
       "31928": "Republic Fleet Medium Shield Extender",
       "3244": "Warp Disruptor II",
       "33816": "Garmur",
       "35658": "5MN Quad LiF Restrained Microwarpdrive",
       "3756": "Gnosis",
       "5445": "Initiated Compact Warp Scrambler",
       "583867044": "Ceptacemia",
       "90442902": "Corran Nevvers",
       "98295759": "Usque Ad Mortem",
       "99007892": "Violente Fortuna"
    },
    "systemInfo": {
       "celestialID": 40184139,
       "celestialName": "YA0-XJ VIII - Asteroid Belt 1",
       "regionID": 10000035,
       "regionName": "Deklein",
       "solarSystemName": "YA0-XJ",
       "solarSystemID": 30002902
    },
    "dna": "morf1_t1:mordubase:mordu"
 }



$(document).ready(function () {
    populateModules(package)
    getShip(package);
    getAttackers(package);
});

function setResonancePercentage(resonance, value) {
    if (!value) {
        value = 1;
    }
    value = 1 - value;
    value = (value * 100).toFixed(0);
    $('#' + resonance).css('width', value + '%').attr('aria-valuenow', value);
    $('#' + resonance).text(value + "%");
}

function setModuleSlot(type, slot, i) {
    typeNames = package.attributes.types;
    $("#" + type + slot).prepend('<img src="//imageserver.eveonline.com/Type/' + i.typeID + '_32.png" title="' + typeNames[i.typeID] + '" style="height: 32px; width: 32px;">')
    if (i.chargeTypeID > 0) $("#" + type + slot + "l").prepend('<img src="//imageserver.eveonline.com/Type/' + i.chargeTypeID + '_32.png" style="height: 32px; width: 32px;">')
}

function populateModules(package) {
    typeNames = package.attributes.types;
    $.each(package.attributes.modules, function (k, i) {
        switch (i.location) {
            case 27: // hiSlots
                setModuleSlot("high", "1", i);
                break;
            case 28: // hiSlots
                setModuleSlot("high", "2", i);
                break;
            case 29: // hiSlots
                setModuleSlot("high", "3", i);
                break;
            case 30: // hiSlots
                setModuleSlot("high", "4", i);
                break;
            case 31: // hiSlots
                setModuleSlot("high", "5", i);
                break;
            case 32: // hiSlots
                setModuleSlot("high", "6", i);
                break;
            case 33: // hiSlots
                setModuleSlot("high", "7", i);
                break;
            case 34: // hiSlots
                setModuleSlot("high", "8", i);
                break;

            case 19:
                setModuleSlot("mid", "1", i);
                break;
            case 20:
                setModuleSlot("mid", "2", i);
                break;
            case 21:
                setModuleSlot("mid", "3", i);
                break;
            case 22:
                setModuleSlot("mid", "4", i);
                break;
            case 23:
                setModuleSlot("mid", "5", i);
                break;
            case 24:
                setModuleSlot("mid", "6", i);
                break;
            case 25:
                setModuleSlot("mid", "7", i);
                break;
            case 26:
                setModuleSlot("mid", "8", i);
                break;

            case 11:
                setModuleSlot("low", "1", i);
                break;
            case 12:
                setModuleSlot("low", "2", i);
                break;
            case 13:
                setModuleSlot("low", "3", i);
                break;
            case 14:
                setModuleSlot("low", "4", i);
                break;
            case 15:
                setModuleSlot("low", "5", i);
                break;
            case 16:
                setModuleSlot("low", "6", i);
                break;
            case 17:
                setModuleSlot("low", "7", i);
                break;
            case 18:
                setModuleSlot("low", "8", i);
                break;

            case 92:
                setModuleSlot("rig", "1", i);
                break;

            case 93:
                setModuleSlot("rig", "2", i);
                break;
            case 94:
                setModuleSlot("rig", "3", i);
                break;

            case 164:
                setModuleSlot("sub", "1", i);
                break;
            case 165:
                setModuleSlot("sub", "2", i);
                break;
            case 166:
                setModuleSlot("sub", "3", i);
                break;
            case 167:
                setModuleSlot("sub", "4", i);
                break;
            case 168:
                setModuleSlot("sub", "5", i);
                break;
        }
    });
}

function getPortrait(a) {
    if (a.character_id != undefined) {
        return "character/" + a.character_id + "_64.jpg";
    } else if (a.corporation_id != undefined) {
        return "corporation/" + a.corporation_id + "_64.png";
    } else {
        return "corporation/" + a.faction_id + "_64.png";
    }
}

function getShipImage(a) {
    return a.ship_type_id + "_32.png";
}

function getWeaponImage(a) {
    return a.weapon_type_id == undefined ?
        a.ship_type_id + "_32.png" :
        a.weapon_type_id + "_32.png";
}

function getThatStuff(a) {
    var theStuff = "";

    if (a.character_id != undefined) theStuff += package.nameMap[a.character_id] + "<br>";
    if (a.corporation_id != undefined) theStuff += package.nameMap[a.corporation_id] + "<br>"
    if (a.alliance_id != undefined) theStuff += package.nameMap[a.alliance_id] + "<br>"
    if (a.faction_id != undefined) theStuff += package.nameMap[a.faction_id] + "<br>"

    return theStuff;
}

function getAttackers(package) {
    $("#numInvolved").text(simpleVal(package.killmail.attackers.length) + " Involved");
    var stripe = false;
    $.each(package.killmail.attackers, function (k, a) {
        var row = `
            <div class="row killmail" style="background-color: ${stripe ? "#06100a;" : "#16201a;"} padding: 0px;">
                <div class="col-xs-2 killmail" style="width: 64px">
                    <img src="//imageserver.eveonline.com/${getPortrait(a)}" style="width:64px; height: 64px">
                </div>
                <div class="col-xs-1 killmail" style="width: 32px">
                    <img src="//imageserver.eveonline.com/type/${getShipImage(a)}" style="width:32px; height: 32px">
                    <img src="//imageserver.eveonline.com/type/${getWeaponImage(a)}" style="width:32px; height: 32px">
                </div>
                <div class="col-xs-9 killmail" style="width: 264px;">
                    <div class="row" style="height: 64px; padding: 5px;">
                        <div class="col-xs-9">
                           ${getThatStuff(a)}
                        </div>
                        <div class="col-xs-3" style="height: 64px; text-align: right">
                            ${simpleVal(a.damage_done)}
                        </div>
                    </div>
                </div>
            </div>`;

        $("#attackers").append(row);
        stripe = !stripe;
    });
}

function getShipwebGL(package) {
    $("#shipImage").attr("src", "//imageserver.eveonline.com/Render/" + package.attributes.typeID + "_256.png")
    try {
        var mat4 = ccpwgl_int.math.mat4,
            rotation = 0.0,
            direction = 0.001,
            canvas = document.getElementById('shipCanvas');

        ccpwgl.initialize(canvas, {});

        camera = ccpwgl.createCamera(canvas, {}, true);

        scene = ccpwgl.loadScene('res:/dx9/scene/universe/m10_cube.red');
        var ship = scene.loadShip(package.dna);
        scene.loadSun('res:/fisfx/lensflare/purple_sun.red');


        var sizes = ['c', 'd', 'h', 'l', 'm', 's', 't'];
        var races = ['amarr', 'angel', 'blooodraider', 'caldari', 'concord', 'gallente', 'generic', 'jove', 'minmatar', 'ore', 'rogue', 'sansha', 'sepentis', 'sleeper', 'soct', 'soe', 'talocan'];
        var radius = 50;

        var explosions = [];
        var currentTime = 0;

        function getRandomExplosion(explodionData)
        {
            var size = sizes[Math.floor(Math.random() * sizes.length)];
            var race = races[Math.floor(Math.random() * races.length)];
            var explosion = scene.loadObject('res:/fisfx/deathexplosion/death_' + size + '_' + race + '.red', function ()
            {
                this.wrappedObjects[0].Start();
                explodionData[1] = currentTime + this.wrappedObjects[0].duration;
            });
            explosion.setTransform([
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                Math.random() * 2 * radius - radius, Math.random() * 2 * radius - radius, Math.random() * 2 * radius - radius, 1
            ]);
            return explosion;
        }

        function spawnExplosion()
        {
            for (var i = 0; i < explosions.length;)
            {
                if (currentTime > explosions[i][1])
                {
                    scene.removeObject(scene.indexOf(explosions[i][0]));
                    explosions.splice(i, 1);
                }
                else
                {
                    ++i;
                }
            }
            var explosion = [null, 0];
            explosion[0] = getRandomExplosion(explosion);
            explosions.push(explosion);
            window.setTimeout(spawnExplosion, 2000 + Math.random() * 2000);
        }

        spawnExplosion();

        ccpwgl.onPreRender = function (dt) {
            camera.rotationX += 0.01;
            camera.rotationY += direction;
            if (camera.rotationY > 1.57 & direction > 0) {
                direction = -0.001;
            } else if (camera.rotationY < -1.57 & direction < 0) {
                direction = 0.001;
            }
            if (ship.isLoaded() == true) {
                $("#shipImage").addClass("hidden");
            }
            camera.focus(ship, 5, 1);

          

        }
    } catch (err) {
        getShipFallback(package.attributes.typeID);
    }
}

function getShipFallback(typeID) {
    var canvas = document.getElementById('shipCanvas');
    canvas.parentNode.removeChild(canvas);
}

function getShip(package) {
    var a = package.attributes.ship;
    getShipwebGL(package);

    setResonancePercentage("shieldEm", a.shieldEmDamageResonance)
    setResonancePercentage("shieldTherm", a.shieldThermalDamageResonance)
    setResonancePercentage("shieldKin", a.shieldKineticDamageResonance)
    setResonancePercentage("shieldExp", a.shieldExplosiveDamageResonance)
    setResonancePercentage("armorEm", a.armorEmDamageResonance)
    setResonancePercentage("armorTherm", a.armorThermalDamageResonance)
    setResonancePercentage("armorKin", a.armorKineticDamageResonance)
    setResonancePercentage("armorExp", a.armorExplosiveDamageResonance)
    setResonancePercentage("hullEm", a.emDamageResonance)
    setResonancePercentage("hullTherm", a.thermalDamageResonance)
    setResonancePercentage("hullKin", a.kineticDamageResonance)
    setResonancePercentage("hullExp", a.explosiveDamageResonance)

    $("#ehp").text(simpleVal(a.maxEHP) + " EHP");

    $("#hullHP").text(simpleVal(a.hp) + " HP");
    $("#armorHP").text(simpleVal(a.armorHP) + " HP");
    $("#shieldHP").text(simpleVal(a.shieldCapacity) + " HP");

    $("#rps").text(simpleVal(a.maxRPS) + " EHP/s");

    $("#warpStrength").text(simpleVal(a.totalWarpScrambleStrength));
    $("#webStrength").text(simpleVal(a.stasisWebifierStrength) + "%");
    $("#targets").text(simpleVal(a.maxLockedTargets));
    $("#scanRes").text(simpleVal(a.scanResolution));

    $("#cargo").text(simpleVal(a.capacity) + " m³");

    $("#lockRange").text(simpleVal(a.maxTargetRange / 1000) + " km");
    $("#warpSpeed").text(simpleVal(a.warpSpeedMultiplier, 1) + " AU/s");

    $("#speed").text(simpleVal(a.maxVelocity) + " km/s");
    $("#mwdSpeed").text(simpleVal(a.maxVelocityMWD) + " km/s");

    $("#sigRadius").text(simpleVal(a.signatureRadius));
    $("#mwdSigRadius").text(simpleVal(a.signatureRadiusMWD));

    $.each(a, function (k, v) {
        switch (k) {
            case "hiSlots": // hiSlots
                $("#hiSlots").attr('src', '/i/fw/' + v + 'h.png');
                break;
            case "medSlots": // medSlots
                $("#medSlots").attr('src', '/i/fw/' + v + 'm.png');
                break;
            case "lowSlots": // lowSlots
                $("#lowSlots").attr('src', '/i/fw/' + v + 'l.png');
                break;
            case "rigSlots": // rigSlots
                $("#rigSlots").attr('src', '/i/fw/' + v + 'r.png');
                break;
            case "maxSubsystems": // SubSystems
                $("#subSlots").attr('src', '/i/fw/' + v + 's.png');
                break;
            case "serviceSlots": // structure services
                $("#subSlots").attr('src', '/i/fw/' + att + 's.png');
                break;
            case "capacitorCapacity":
                if (a.capacitorStable == 1.0) {
                    $("#capacitorDuration").text((100 * a.capacitorFraction).toFixed(0) + "% Stable");
                } else {
                    $("#capacitorDuration").text(convertMS(a.capacitorDuration));
                }

                $("#capacitorDetails").text(simpleVal(v) + " GJ")
                break;
            case "totalDPS":
                $("#totalDamage").html(v.toFixed(0) + " DPS")
                if (a.moduleDPS) $("#offenseModule").html(simpleVal(a.moduleDPS) + " DPS<br>" + simpleVal(a.moduleAlphaDamage) + " Alpha")
                if (a.droneDPS) $("#offenseDrone").html(simpleVal(a.droneDPS) + " DPS<br>" + simpleVal(a.droneAlphaDamage) + " Alpha")
                break;

            case "scanRadarStrength":
                $("#sensorStrength").text(simpleVal(v));
                break;
            case "scanLadarStrength":
                $("#sensorStrength").text(simpleVal(v));
                break;
            case "scanMagnetometricStrength":
                $("#sensorStrength").text(simpleVal(v));
                break;
            case "scanGravimetricStrength":
                $("#sensorStrength").text(simpleVal(v));
                break;
            case "remoteArmorDamageAmountPerSecond":
                $("#remoteArmor").text(simpleVal(v) + " hp/s");
                $(".remoteRepair").removeClass('hidden');
                break;
            case "remoteStructureDamageAmountPerSecond":
                $("#remoteHull").text(simpleVal(v) + " hp/s");
                $(".remoteRepair").removeClass('hidden');
                break;
            case "remoteShieldBonusAmountPerSecond":
                $("#remoteShield").text(simpleVal(v) + " hp/s");
                $(".remoteRepair").removeClass('hidden');
                break;
            case "remotePowerTransferAmountPerSecond":
                $("#remotePower").text(simpleVal(v) + " GJ/s");
                $(".remoteRepair").removeClass('hidden');
                break;
        }
    });
}

